<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AHMED PULSE | ULTIMATE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --gold: #ffd700;
            --bg-deep: #050508;
            --glass-bg: rgba(20, 20, 30, 0.85);
            --card-bg: rgba(30, 30, 40, 0.95);
            --sidebar-w: 260px;
            --player-h: 100px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0;
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-deep); color: #fff; 
            height: 100vh; overflow: hidden;
            transition: background 0.5s;
        }

        /* --- تنبيهات الشبكة الجديدة --- */
        #net-status {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 0, 85, 0.9);
            color: white; text-align: center; padding: 5px; font-size: 12px;
            z-index: 9999; display: none; font-weight: bold;
        }
        #net-status.weak { background: rgba(255, 166, 0, 0.9); color: black; }

        /* --- نظام الخلفيات --- */
        .bg-layer {
            position: fixed; inset: 0; z-index: -2;
            width: 100%; height: 100%;
            transition: opacity 1s ease;
        }
        #dynamic-bg-img {
            background-size: cover; background-position: center; background-repeat: no-repeat;
            opacity: 1; 
        }
        #dynamic-bg-video {
            object-fit: cover; display: none;
        }

        /* أنماط العرض */
        .fit-cover { background-size: cover !important; }
        .fit-contain { background-size: contain !important; background-color: #000; }

        /* أنماط الحركة */
        @keyframes kf-zoom-in { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
        @keyframes kf-zoom-out { 0% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes kf-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .anim-static { transform: scale(1); }
        .anim-zoom-in { animation: kf-zoom-in 20s infinite alternate linear; }
        .anim-zoom-out { animation: kf-zoom-out 20s infinite alternate linear; }
        .anim-pulse { animation: kf-pulse 10s infinite ease-in-out; }

        .overlay { 
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 40%);
            pointer-events: none;
        }
        body.dark-mode .overlay { background: rgba(0,0,0,0.7); }

        /* --- التخطيط --- */
        .layout { display: flex; height: calc(100% - var(--player-h)); position: relative; }
        
        .sidebar {
            width: var(--sidebar-w); 
            background: var(--glass-bg);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; padding: 30px 20px;
            z-index: 20; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .brand { 
            font-size: 26px; font-weight: 900; margin-bottom: 40px; 
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.5);
        }
        .brand span { color: var(--primary); }
        
        .nav-btn {
            padding: 14px 18px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; color: #ccc; transition: 0.2s;
            display: flex; align-items: center; gap: 15px; font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(0, 242, 255, 0.15); color: white; }
        .nav-btn.active { border-right: 4px solid var(--primary); }
        
        .content { 
            flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; 
            padding-bottom: 150px;
        }
        .content::-webkit-scrollbar { width: 5px; }
        .content::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }

        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        #hero-txt {
            font-size: clamp(2.5rem, 6vw, 4.5rem); margin: 0; font-weight: 900; line-height:1.4;
            text-shadow: 0 4px 10px rgba(0,0,0,1), 0 0 20px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.5);
        }

        /* اليوميات */
        .diary-input-area { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #444; }
        .diary-feed { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 800px; margin: 0 auto; }
        .diary-post {
            background: var(--card-bg); border-radius: 15px;
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 100%;
        }
        .diary-post.admin-post { border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.15); }
        .post-header { padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; display: grid; place-items: center; font-weight: bold; color: #fff; font-size: 18px; }
        .admin-post .avatar { background: var(--gold); color: #000; }
        .post-body { padding: 15px; font-size: 15px; line-height: 1.6; color: #eee; white-space: pre-wrap; word-wrap: break-word; }
        .post-actions { padding: 5px; display: flex; }
        .action-btn { background: none; border: none; color: #aaa; cursor: pointer; flex: 1; font-size: 14px; padding: 10px; border-radius: 8px; transition: 0.2s; }
        .action-btn:hover { background: rgba(255,255,255,0.05); color: white; }

        /* المشغل */
        .music-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-h);
            background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100;
        }
        #visualizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.4; pointer-events: none; }
        .player-content { position: relative; z-index: 1; display: flex; width: 100%; align-items: center; justify-content: space-between; }
        .play-btn-main { width: 55px; height: 55px; background: white; color: black; border-radius: 50%; display: grid; place-items: center; font-size: 22px; cursor: pointer; transition: 0.2s; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .play-btn-main:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--primary); background: var(--primary); }
        .ctrl-btn { color: white; background: none; border: none; font-size: 24px; cursor: pointer; margin: 0 15px; transition: 0.2s; }
        .ctrl-btn:hover { color: var(--primary); }
        #p-desc { font-size: 12px; color: var(--gold) !important; background: rgba(0,0,0,0.7); padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; font-weight: bold; }

        /* Admin & Inputs */
        .admin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; flex-direction: column; backdrop-filter: blur(5px); }
        .admin-header { padding: 20px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .admin-body { display: flex; height: 100%; overflow: hidden; }
        .admin-nav { width: 220px; background: rgba(10,10,10,0.5); padding: 20px; border-left: 1px solid #333; }
        .adm-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .inp, select.inp { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none; transition: 0.3s; }
        .inp:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        select.inp option { background: #222; color: white; }
        
        .btn-glow { background: var(--primary); color: #000; border: none; padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); transition: 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 25px rgba(0, 242, 255, 0.5); transform: translateY(-2px); }

        /* Admin List Items */
        .adm-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid #333; 
            background: rgba(255,255,255,0.03); margin-bottom: 5px; border-radius: 6px;
        }
        .adm-list-item:hover { background: rgba(255,255,255,0.07); }
        .adm-btn-icon { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px 10px; transition: 0.2s; }
        .star-active { color: var(--gold) !important; text-shadow: 0 0 10px var(--gold); transform: scale(1.2); }
        .star-inactive { color: #555; }
        .star-inactive:hover { color: #888; }

        /* Mobile */
        .mob-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mob-nav { display: flex; gap: 10px; overflow-x: auto; padding: 12px; background: rgba(15,15,20,0.95); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #333; }
            .mob-chip { white-space: nowrap; padding: 8px 16px; background: #333; border-radius: 20px; font-size: 13px; color: #ccc; }
            .mob-chip.active { background: var(--primary); color: black; font-weight: bold; }
            .content { padding: 10px; padding-bottom: 130px; }
            .music-bar { height: 130px; padding: 10px; flex-direction: column; justify-content: center; }
            .player-content { flex-direction: column; gap: 8px; width: 100%; }
            .player-left { width: 100%; justify-content: flex-start; }
            .player-right { display: none; }
            .admin-body { flex-direction: column; }
            .admin-nav { width: 100%; height: auto; display: flex; overflow-x: auto; padding: 10px; }
        }
        
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .folder-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s; backdrop-filter: blur(5px); }
        .folder-card:hover { border-color: var(--primary); background: rgba(255,255,255,0.1); transform: translateY(-5px); }
    </style>
</head>
<body>

    <div id="net-status"></div>

    <div id="dynamic-bg-img" class="bg-layer"></div>
    <video id="dynamic-bg-video" class="bg-layer" loop muted playsinline onerror="handleVideoError()"></video>
    
    <div class="overlay"></div>

    <div class="layout">
        <nav class="sidebar">
            <div class="brand">AHMED <span>PULSE</span></div>
            <div class="nav-items-container" id="sidebar-items">
                <div class="nav-btn active" onclick="nav('home')"><i class="fas fa-home"></i> الرئيسية</div>
                <div class="nav-btn" onclick="nav('music')"><i class="fas fa-music"></i> الموسيقى</div>
                <div class="nav-btn" onclick="nav('diaries')"><i class="fas fa-users"></i> المجتمع</div>
                <div class="nav-btn" onclick="nav('contact')"><i class="fas fa-envelope"></i> تواصل معي</div>
            </div>
            <div style="margin-top:auto; text-align:center;">
                <button onclick="openAdmin()" style="background:none; border:none; color:#ddd; cursor:pointer; font-size:14px; text-shadow:0 1px 2px #000;"><i class="fas fa-cog"></i> لوحة التحكم</button>
            </div>
        </nav>

        <main class="content">
            <div class="mob-nav" id="mob-nav-items">
                <div class="mob-chip active" onclick="nav('home')">الرئيسية</div>
                <div class="mob-chip" onclick="nav('music')">الموسيقى</div>
                <div class="mob-chip" onclick="nav('diaries')">المجتمع</div>
                <div class="mob-chip" onclick="nav('contact')">اتصل</div>
            </div>

            <div id="view-home" class="section active">
                <div style="height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <h1 id="hero-txt">...</h1>
                </div>
            </div>

            <div id="view-music" class="section">
                <h2 style="text-shadow: 0 2px 5px #000;">المكتبة الصوتية</h2>
                <div id="folders-view">
                    <div class="folders-grid" id="folders-container"></div>
                </div>
                <div id="songs-view" style="display:none;">
                    <button onclick="showFolders()" style="background:none; border:none; color:var(--primary); font-size:16px; margin-bottom:15px; cursor:pointer; font-weight:bold; text-shadow: 0 1px 2px #000;">
                        <i class="fas fa-arrow-right"></i> رجوع للمجلدات
                    </button>
                    <h3 id="current-folder-title" style="color:#ddd; text-shadow: 0 1px 2px #000;"></h3>
                    <div id="songs-container" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
            </div>

            <div id="view-diaries" class="section">
                <h2 style="text-shadow: 0 2px 5px #000;">مجتمع اليوميات</h2>
                <div class="diary-input-area">
                    <input id="d-name" class="inp" placeholder="اسمك (اختياري)" maxlength="20">
                    <textarea id="d-msg" class="inp" rows="3" placeholder="بم تفكر اليوم؟"></textarea>
                    <button onclick="postDiary()" class="btn-glow" style="width:100%;">نشر <i class="fas fa-paper-plane"></i></button>
                </div>
                <div id="diary-feed" class="diary-feed">
                    <div id="loading-spinner" style="text-align:center; color:#ccc; padding:20px;">
                        <i class="fas fa-circle-notch fa-spin"></i> جاري تحميل المنشورات...
                    </div>
                </div>
            </div>

            <div id="view-contact" class="section">
                <div style="max-width:500px; margin:auto; background:var(--card-bg); padding:30px; border-radius:15px; border:1px solid #444;">
                    <h2 style="text-align:center; border:none;">راسلني</h2>
                    <input id="c-name" class="inp" placeholder="الاسم">
                    <textarea id="c-msg" class="inp" rows="4" placeholder="رسالتك..."></textarea>
                    <button onclick="sendMsg()" class="btn-glow" style="width:100%">إرسال</button>
                </div>
            </div>

            <div id="dynamic-pages-container"></div>
        </main>
    </div>

    <div class="music-bar">
        <canvas id="visualizer"></canvas>
        <div class="player-content">
            <div class="player-left" style="display:flex; align-items:center; gap:15px; width:280px;">
                <div id="p-art" style="width:60px; height:60px; border-radius:12px; background:#333; background-size:cover; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>
                <div style="overflow:hidden;">
                    <div id="p-title" style="font-weight:bold; font-size:15px; white-space:nowrap; text-shadow:0 1px 2px black;">اختر أغنية</div>
                    <div id="p-desc">...</div>
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                    <button class="ctrl-btn" onclick="prev()"><i class="fas fa-step-backward"></i></button>
                    <div class="play-btn-main" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></div>
                    <button class="ctrl-btn" onclick="next()"><i class="fas fa-step-forward"></i></button>
                </div>
                <div style="width:100%; max-width:450px; height:5px; background:rgba(255,255,255,0.1); border-radius:5px; cursor:pointer; overflow:hidden;" onclick="seek(event)">
                    <div id="prog-fill" style="width:0%; height:100%; background:var(--primary); position:relative; box-shadow:0 0 10px var(--primary);"></div>
                </div>
            </div>

            <div class="player-right" style="width:200px; text-align:left;">
                <i class="fas fa-volume-up" style="color:#aaa; margin-left:5px;"></i>
                <input type="range" style="width:80px; accent-color:var(--primary);" min="0" max="1" step="0.1" oninput="audio.volume=this.value">
            </div>
        </div>
    </div>

    <div id="admin-panel" class="admin-modal">
        <div class="admin-header">
            <b style="color:var(--primary); font-size:20px;">لوحة التحكم <i class="fas fa-user-shield"></i></b>
            <button onclick="document.getElementById('admin-panel').style.display='none'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">✕</button>
        </div>
        <div class="admin-body">
            <div class="admin-nav">
                <div class="nav-btn active" onclick="admTab('inbox')">الرسائل</div>
                <div class="nav-btn" onclick="admTab('music')">الموسيقى</div>
                <div class="nav-btn" onclick="admTab('pages')">الصفحات</div>
                <div class="nav-btn" onclick="admTab('settings')">الإعدادات</div>
            </div>
            <div class="adm-content">
                <div id="adm-inbox" class="section active">
                    <h3>البريد الوارد</h3>
                    <div id="inbox-list"></div>
                </div>
                <div id="adm-music" class="section">
                    <h3>إدارة الموسيقى</h3>
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px;">
                        
                        <label style="color:#aaa; font-size:12px;">اختر المجلد:</label>
                        <select id="folder-select" class="inp" onchange="toggleFolderInput()">
                            <option value="new">++ مجلد جديد ++</option>
                        </select>
                        <input id="new-folder-input" class="inp" placeholder="اكتب اسم المجلد الجديد هنا" style="display:block;">
                        <input id="add-title" class="inp" placeholder="اسم الأغنية">
                        <input id="add-url" class="inp" placeholder="رابط الصوت (MP3 URL)">
                        <input id="add-img" class="inp" placeholder="رابط الصورة (Image URL)">
                        <button onclick="addSong()" class="btn-glow" style="font-size:13px;">إضافة للمكتبة</button>
                    </div>
                    <h4 style="color:#888;">الأغاني الحالية</h4>
                    <div id="adm-music-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div id="adm-pages" class="section">
                    <h3>منشئ الصفحات</h3>
                    <input id="page-id" class="inp" placeholder="Page ID">
                    <input id="page-title" class="inp" placeholder="العنوان في القائمة">
                    <input id="page-icon" class="inp" placeholder="أيقونة (fas fa-star)">
                    <textarea id="page-content" class="inp" rows="5" placeholder="HTML Content"></textarea>
                    <button onclick="savePage()" class="btn-glow">نشر الصفحة</button>
                    <div id="adm-pages-list" style="margin-top:20px;"></div>
                </div>
                
                <div id="adm-settings" class="section">
                    <h3>الإعدادات والمظهر</h3>
                    <label style="color:#aaa;">رسالة الترحيب:</label>
                    <textarea id="set-welcome" class="inp" rows="2"></textarea>
                    
                    <div style="margin-top:20px; padding:20px; background:rgba(255, 215, 0, 0.05); border-radius:12px; border:1px solid rgba(255,215,0,0.2);">
                        <label style="color:var(--gold); font-weight:bold; font-size:15px; display:block; margin-bottom:10px;">✨ التحكم في الخلفية (Hero Mode)</label>
                        
                        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                            <input type="checkbox" id="set-hero-active" style="width:20px; height:20px;"> 
                            <span>تفعيل الخلفية الثابتة (تجاهل صور الأغاني)</span>
                        </div>
                        
                        <label>رابط الصورة أو الفيديو (MP4):</label>
                        <input id="set-hero-img" class="inp" placeholder="URL Link">
                        
                        <label>نوع الملف:</label>
                        <select id="set-hero-type" class="inp">
                            <option value="image">صورة (Image)</option>
                            <option value="video">فيديو (Video)</option>
                        </select>

                        <label>طريقة العرض (للصور):</label>
                        <select id="set-bg-fit" class="inp">
                            <option value="cover">ملء الشاشة (Cover) - يقص الحواف</option>
                            <option value="contain">كامل الصورة (Contain) - يظهر كل التفاصيل</option>
                        </select>

                        <label>الحركة (Animation):</label>
                        <select id="set-anim-type" class="inp">
                            <option value="static">ثابت (بدون حركة)</option>
                            <option value="zoom-in">Zoom In (تكبير للداخل)</option>
                            <option value="zoom-out">Zoom Out (تكبير للخارج)</option>
                            <option value="pulse">Pulse (نبض)</option>
                        </select>
                    </div>
                    
                    <button onclick="saveSettings()" class="btn-glow" style="margin-top:20px; width:100%;">حفظ كافة الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUK7SXiX_uBObNqWjM5u-eKUKkCTwCJKc",
            authDomain: "mypersonalapp-2f2cc.firebaseapp.com",
            databaseURL: "https://mypersonalapp-2f2cc-default-rtdb.firebaseio.com",
            projectId: "mypersonalapp-2f2cc",
            storageBucket: "mypersonalapp-2f2cc.firebasestorage.app",
            messagingSenderId: "1093218114240",
            appId: "1:1093218114240:web:e082d82c94c286d2c6eb25",
            measurementId: "G-W8R99YNJQ9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const ADMIN_EMAIL = "ahmshowpic@gmail.com";

        // Global Vars
        let songs = [], folders = {}, playlist = [], pIndex = 0;
        let isAdmin = false;
        let defaultSongId = null;
        
        // Settings Vars
        let isHeroMode = false;
        let heroUrl = "";
        let heroType = "image"; 
        let bgFit = "cover"; 
        let animType = "static"; 

        const audio = document.getElementById('audio-player');
        audio.removeAttribute('crossorigin');
        
        // --- Smart Network Logic ---
        function getNetworkStatus() {
            // كشف السرعة التقريبي إذا كان المتصفح يدعمه
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                // إذا كان وضع توفير البيانات مفعلاً أو السرعة أقل من 1.5 ميجا
                if (connection.saveData === true || (connection.downlink && connection.downlink < 1.5)) {
                    return 'slow';
                }
            }
            return 'good';
        }

        // مراقبة حالة الاتصال (أونلاين/أوفلاين)
        window.addEventListener('offline', () => updateNetAlert(false));
        window.addEventListener('online', () => updateNetAlert(true));

        function updateNetAlert(isOnline) {
            const el = document.getElementById('net-status');
            if(!isOnline) {
                el.style.display = 'block';
                el.className = '';
                el.innerText = '⚠️ انقطع الاتصال بالإنترنت. بعض الميزات قد لا تعمل.';
            } else {
                // فحص جودة الاتصال عند العودة
                const quality = getNetworkStatus();
                if(quality === 'slow') {
                    el.style.display = 'block';
                    el.className = 'weak';
                    el.innerText = '⚡ الاتصال بطيء. تم تقليل الجودة تلقائياً.';
                    setTimeout(() => el.style.display='none', 5000);
                } else {
                    el.style.display = 'none';
                }
            }
        }

        // إصلاح ذاتي للفيديو المكسور
        function handleVideoError() {
            console.log("Video Error: Switching to Image Fallback");
            const bgImg = document.getElementById('dynamic-bg-img');
            const bgVid = document.getElementById('dynamic-bg-video');
            bgVid.style.display = 'none';
            bgImg.style.opacity = '1';
            // وضع صورة افتراضية
            bgImg.style.backgroundImage = `url('https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1920')`;
        }
        // ---------------------------

        // --- Visualizer ---
        let canvas, canvasCtx, visInterval;
        function initVisualizer() {
            canvas = document.getElementById('visualizer');
            if(!canvas) return;
            canvasCtx = canvas.getContext('2d');
            startFakeVis();
        }
        function startFakeVis() {
            if(visInterval) cancelAnimationFrame(visInterval);
            const draw = () => {
                if(!audio.paused) {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                    canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                    const bars = 60; const w = canvas.width / bars;
                    for(let i=0; i<bars; i++) {
                        const h = Math.random() * (canvas.height * 0.6);
                        canvasCtx.fillStyle = `rgba(0, 242, 255, 0.3)`;
                        canvasCtx.fillRect(i * w, canvas.height - h, w - 2, h);
                    }
                }
                visInterval = requestAnimationFrame(draw);
            };
            draw();
        }

        // --- Auth & Data ---
        auth.onAuthStateChanged(u => {
            isAdmin = (u && u.email === ADMIN_EMAIL);
            if(isAdmin) initAdmin();
            loadGeneralData();
            initDiarySystem();
            initVisualizer();
            updateNetAlert(navigator.onLine); // فحص أولي
        });

        function loadGeneralData() {
            // Music
            db.ref('music').on('value', snap => {
                songs = []; folders = {};
                snap.forEach(c => {
                    const val = c.val();
                    const s = {
                        k: c.key, 
                        name: val.name,
                        folder: val.folder || "منوعات",
                        image: val.image || val.img,
                        url: val.url || val.link 
                    };
                    songs.push(s);
                    if(!folders[s.folder]) folders[s.folder] = [];
                    folders[s.folder].push(s);
                });
                renderFolders();
                checkDefaultSong(); 
                if(isAdmin) {
                    renderAdmMusic();
                    updateAdminFolderSelect();
                }
            });

            // Settings
            db.ref('settings').on('value', s => {
                const val = s.val() || {};
                
                document.getElementById('hero-txt').innerText = val.welcome || "Welcome";
                
                defaultSongId = val.defaultSongId;
                isHeroMode = (val.heroMode === true);
                heroUrl = val.heroImg || "";
                heroType = val.heroType || "image";
                bgFit = val.bgFit || "cover";
                animType = val.animType || "static";

                checkDefaultSong(); 
                updateBackgroundState();

                if(isAdmin) {
                    if(document.getElementById('set-welcome')) document.getElementById('set-welcome').value = val.welcome || "";
                    if(document.getElementById('set-hero-active')) document.getElementById('set-hero-active').checked = isHeroMode;
                    if(document.getElementById('set-hero-img')) document.getElementById('set-hero-img').value = heroUrl;
                    
                    if(document.getElementById('set-hero-type')) document.getElementById('set-hero-type').value = heroType;
                    if(document.getElementById('set-bg-fit')) document.getElementById('set-bg-fit').value = bgFit;
                    if(document.getElementById('set-anim-type')) document.getElementById('set-anim-type').value = animType;
                    renderAdmMusic();
                }
            });

            // Pages
            db.ref('custom_pages').on('value', s => {
                document.querySelectorAll('.dyn').forEach(e=>e.remove());
                const admL = document.getElementById('adm-pages-list');
                if(admL) admL.innerHTML = "";
                s.forEach(c => {
                    const p = c.val();
                    const pid = c.key;
                    const btn = document.createElement('div');
                    btn.className = "nav-btn dyn"; btn.innerHTML = `<i class="${p.icon}"></i> ${p.title}`; btn.onclick = () => nav(pid);
                    document.getElementById('sidebar-items').appendChild(btn);
                    
                    const mb = document.createElement('div');
                    mb.className = "mob-chip dyn"; mb.innerText = p.title; mb.onclick = () => nav(pid);
                    document.getElementById('mob-nav-items').appendChild(mb);
                    
                    const sec = document.createElement('div');
                    sec.className = "section dyn-sec"; sec.id = "view-"+pid; sec.innerHTML = `<h2>${p.title}</h2><div>${p.content}</div>`;
                    document.getElementById('dynamic-pages-container').appendChild(sec);
                    
                    if(admL) admL.innerHTML += `<div>${p.title} <button onclick="db.ref('custom_pages/${pid}').remove()" style="color:red">X</button></div>`;
                });
            });
        }

        // --- Background Logic (SMART) ---
        function updateBackgroundState() {
            let targetUrl = "";
            let targetType = "image";

            if (isHeroMode) {
                targetUrl = heroUrl;
                targetType = heroType;
            } else {
                if (audio.src && playlist[pIndex]) {
                    targetUrl = playlist[pIndex].image;
                }
                targetType = "image"; 
            }
            if (!targetUrl) targetUrl = "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1920";
            
            // --- Smart Check: If net is slow, force IMAGE mode ---
            const netStatus = getNetworkStatus();
            if (netStatus === 'slow' && targetType === 'video') {
                console.log("Slow network detected: Forcing Image Mode");
                targetType = 'image';
                // إذا كان الرابط فيديو، استخدم صورة افتراضية أو صورة الأغنية بدلاً منه
                if(targetUrl.endsWith('.mp4') || targetUrl.endsWith('.webm')) {
                    targetUrl = "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1920"; 
                }
                // إظهار تنبيه
                updateNetAlert(true);
            }
            // ----------------------------------------------------

            applyBackground(targetUrl, targetType);
        }

        function applyBackground(url, type) {
            const bgImg = document.getElementById('dynamic-bg-img');
            const bgVid = document.getElementById('dynamic-bg-video');

            bgImg.className = "bg-layer";
            bgVid.className = "bg-layer";

            if (type === 'video') {
                bgImg.style.opacity = '0';
                bgVid.style.display = 'block';
                // منع إعادة التحميل إذا كان نفس الفيديو يعمل
                if(bgVid.src !== url) {
                    bgVid.src = url;
                    bgVid.play().catch(e=>console.log("Autoplay blocked/Interrupted"));
                }
                bgVid.style.objectFit = (bgFit === 'contain') ? 'contain' : 'cover';
            } else {
                bgVid.style.display = 'none';
                bgVid.pause();
                bgImg.style.opacity = '1';
                bgImg.style.backgroundImage = `url('${url}')`;
                bgImg.classList.add(bgFit === 'contain' ? 'fit-contain' : 'fit-cover');
                bgImg.classList.remove('anim-zoom-in', 'anim-zoom-out', 'anim-pulse', 'anim-static');
                
                if(animType === 'zoom-in') bgImg.classList.add('anim-zoom-in');
                else if(animType === 'zoom-out') bgImg.classList.add('anim-zoom-out');
                else if(animType === 'pulse') bgImg.classList.add('anim-pulse');
                else bgImg.classList.add('anim-static');
            }
        }

        // --- Song Logic ---
        function checkDefaultSong() {
            if(!audio.src && defaultSongId && songs.length > 0) {
                const song = songs.find(s => s.k === defaultSongId);
                if(song) {
                    document.getElementById('p-title').innerText = song.name;
                    document.getElementById('p-desc').innerText = song.folder;
                    document.getElementById('p-art').style.backgroundImage = `url('${song.image}')`;
                    audio.src = song.url;
                    playlist = folders[song.folder] || songs;
                    pIndex = playlist.findIndex(s => s.k === song.k);
                    updateBackgroundState();
                }
            }
        }

        function playSong(i) {
            pIndex = i;
            const s = playlist[pIndex];
            if(!s.url) return;
            audio.src = s.url;
            audio.play().catch(e => console.log(e));
            document.getElementById('p-title').innerText = s.name;
            document.getElementById('p-desc').innerText = s.folder;
            document.getElementById('p-art').style.backgroundImage = `url('${s.image}')`;
            document.getElementById('play-icon').className = "fas fa-pause";
            updateBackgroundState();
        }

        function togglePlay() {
            if(audio.paused) { 
                if(audio.src) { audio.play(); document.getElementById('play-icon').className="fas fa-pause"; }
            } else { 
                audio.pause(); document.getElementById('play-icon').className="fas fa-play"; 
            }
        }
        function next() { if(playlist.length) playSong((pIndex+1)%playlist.length); }
        function prev() { if(playlist.length) playSong((pIndex-1+playlist.length)%playlist.length); }
        
        audio.ontimeupdate = () => { if(audio.duration) document.getElementById('prog-fill').style.width = ((audio.currentTime/audio.duration)*100)+"%"; };
        // --- AUTO PLAY NEXT SONG ---
        audio.onended = () => { next(); }; 
        // ---------------------------

        function seek(e) { if(audio.duration) audio.currentTime = (e.offsetX / e.target.offsetWidth) * audio.duration; }

        // --- UI & Admin ---
        function nav(id) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn, .mob-chip').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll(`[onclick="nav('${id}')"]`).forEach(b=>b.classList.add('active'));
            if(id === 'home') document.body.classList.remove('dark-mode'); else document.body.classList.add('dark-mode');
        }

        function openAdmin() {
            if(isAdmin) document.getElementById('admin-panel').style.display='flex';
            else auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(r=>{
                if(r.user.email!==ADMIN_EMAIL) { auth.signOut(); alert("للمسؤول فقط."); } 
                else document.getElementById('admin-panel').style.display='flex';
            }).catch(e => alert(e.message));
        }

        function saveSettings() {
            db.ref('settings').update({
                welcome: document.getElementById('set-welcome').value,
                heroMode: document.getElementById('set-hero-active').checked,
                heroImg: document.getElementById('set-hero-img').value,
                heroType: document.getElementById('set-hero-type').value,
                bgFit: document.getElementById('set-bg-fit').value,
                animType: document.getElementById('set-anim-type').value
            });
            alert("تم حفظ الإعدادات!");
        }

        // --- Diary & Utils ---
        function initDiarySystem() {
            const feed = document.getElementById('diary-feed');
            const ref = db.ref('diaries').limitToLast(50);
            ref.on('child_added', snapshot => {
                if(document.getElementById('loading-spinner')) document.getElementById('loading-spinner').remove();
                feed.prepend(createPostElement({k: snapshot.key, ...snapshot.val()})); 
            });
            ref.on('child_changed', snap => {
                const old = document.getElementById('post-'+snap.key);
                if(old) feed.replaceChild(createPostElement({k: snap.key, ...snap.val()}), old);
            });
            ref.on('child_removed', snap => { const e=document.getElementById('post-'+snap.key); if(e) e.remove(); });
        }
        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = `diary-post ${post.verified?'admin-post':''}`; div.id='post-'+post.k;
            const delBtn = isAdmin ? `<button onclick="db.ref('diaries/${post.k}').remove()" style="margin-right:auto; color:red; background:none; border:none;">✕</button>` : '';
            div.innerHTML = `<div class="post-header"><div class="avatar">${post.name[0]}</div><h4>${escapeHtml(post.name)} ${post.verified?'<i class="fas fa-check-circle verified"></i>':''}</h4>${delBtn}</div><div class="post-body">${escapeHtml(post.text)}</div><div class="post-actions"><button class="action-btn" onclick="db.ref('diaries/${post.k}/likes').transaction(l=>l+1)"><i class="far fa-thumbs-up"></i> ${post.likes||0}</button></div>`;
            return div;
        }
        function postDiary() {
            const n=document.getElementById('d-name').value||"مجهول", m=document.getElementById('d-msg').value;
            if(!m) return;
            const ver = (isAdmin && confirm("نشر كمسؤول؟"));
            db.ref('diaries').push({name:ver?"AHMED PULSE":n, text:m, verified:ver, date:new Date().toLocaleDateString('ar-EG'), likes:0});
            document.getElementById('d-msg').value="";
        }
        function initAdmin() {
            db.ref('inbox').on('value', s=>{ const l=document.getElementById('inbox-list'); l.innerHTML=""; s.forEach(c=>{ l.innerHTML+=`<div style="background:#222; padding:10px; margin-bottom:5px;">${escapeHtml(c.val().msg)} <button style="color:red" onclick="db.ref('inbox/${c.key}').remove()">✕</button></div>`; }); });
        }
        function admTab(t) { document.querySelectorAll('.adm-content .section').forEach(e=>e.classList.remove('active')); document.getElementById('adm-'+t).classList.add('active'); }
        
        // --- NEW ADMIN FOLDER LOGIC ---
        function updateAdminFolderSelect() {
            const sel = document.getElementById('folder-select');
            if(!sel) return;
            let html = '<option value="new">++ مجلد جديد ++</option>';
            Object.keys(folders).forEach(f => {
                html += `<option value="${f}">${f}</option>`;
            });
            sel.innerHTML = html;
        }

        function toggleFolderInput() {
            const sel = document.getElementById('folder-select');
            const inp = document.getElementById('new-folder-input');
            if(sel.value === 'new') inp.style.display = 'block';
            else inp.style.display = 'none';
        }

        function addSong() {
            const sel = document.getElementById('folder-select');
            const inp = document.getElementById('new-folder-input');
            
            let finalFolder = "";
            if(sel.value === 'new') finalFolder = inp.value;
            else finalFolder = sel.value;

            if(!finalFolder) return alert("الرجاء اختيار مجلد أو كتابة اسم جديد");

            db.ref('music').push({
                folder: finalFolder, 
                name: document.getElementById('add-title').value,
                url: document.getElementById('add-url').value, 
                image: document.getElementById('add-img').value
            }); 
            alert("تمت الإضافة");
        }
        // ------------------------------

        function renderAdmMusic() {
            const l = document.getElementById('adm-music-list'); 
            if(!l) return; 
            l.innerHTML = "";
            songs.forEach(s => { 
                const isDefault = (s.k === defaultSongId);
                const starClass = isDefault ? 'star-active' : 'star-inactive';
                l.innerHTML += `
                    <div class="adm-list-item">
                        <span>${s.name} (${s.folder})</span>
                        <div>
                            <button class="adm-btn-icon ${starClass}" onclick="setDefaultSong('${s.k}')" title="تعيين كافتراضي">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="adm-btn-icon" onclick="deleteSong('${s.k}')" style="color:#ff5555" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `; 
            });
        }
        function setDefaultSong(id) { db.ref('settings').update({defaultSongId: id}); }
        function deleteSong(id) { if(confirm('حذف هذه الأغنية؟')) db.ref('music/'+id).remove(); }
        function savePage() {
            const id=document.getElementById('page-id').value;
            if(id) db.ref('custom_pages/'+id).set({title:document.getElementById('page-title').value, icon:document.getElementById('page-icon').value, content:document.getElementById('page-content').value});
            alert("تم");
        }
        function sendMsg() { const n=document.getElementById('c-name').value, m=document.getElementById('c-msg').value; if(m){db.ref('inbox').push({name:n, msg:m}); alert("تم");} }
        function renderFolders() {
            const c=document.getElementById('folders-container'); c.innerHTML="";
            Object.keys(folders).forEach(f=>{ c.innerHTML+=`<div class="folder-card" onclick="openFolder('${f}')"><i class="fas fa-folder" style="font-size:40px; color:var(--gold)"></i><div>${f}</div></div>`; });
        }
        function openFolder(f) { document.getElementById('folders-view').style.display='none'; document.getElementById('songs-view').style.display='block'; document.getElementById('current-folder-title').innerText=f; const c=document.getElementById('songs-container'); c.innerHTML=""; playlist=folders[f]; playlist.forEach((s,i)=>{ c.innerHTML+=`<div onclick="playSong(${i})" style="display:flex; gap:10px; padding:10px; cursor:pointer;"><div style="width:40px; height:40px; background:url('${s.image}') center/cover;"></div><div>${s.name}</div></div>`; }); }
        function showFolders() { document.getElementById('songs-view').style.display='none'; document.getElementById('folders-view').style.display='grid'; }
        function escapeHtml(t) { return t?String(t).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])):''; }

    </script>
</body>
</html>
