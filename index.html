<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AHMED SAYED | PRO V2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --gold: #ffd700;
            --bg-deep: #050508;
            --panel-bg: rgba(20, 20, 35, 0.7);
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --sidebar-w: 260px;
            --player-h: 95px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-deep); color: white; 
            height: 100vh; height: 100dvh; overflow: hidden;
        }

        /* --- خلفية وتأثيرات --- */
        #dynamic-bg {
            position: fixed; inset: 0; z-index: -2;
            background-size: cover; background-position: center;
            transition: opacity 1s ease-in-out;
            opacity: 0.5; filter: blur(20px) brightness(0.6);
        }
        .overlay { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at center, transparent 0%, #000 100%); 
            z-index: -1; 
        }

        .layout { display: flex; height: calc(100% - var(--player-h)); position: relative; }
        
        /* --- القائمة الجانبية --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--panel-bg);
            border-left: 1px solid var(--border); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; padding: 30px 20px;
            z-index: 10; flex-shrink: 0;
        }
        .brand { font-size: 26px; font-weight: 900; margin-bottom: 40px; letter-spacing: 1px; color:white; }
        .brand span { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        
        .nav-btn {
            padding: 15px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; color: #aaa; transition: 0.3s; display: flex; align-items: center; gap: 15px; font-weight: 600; font-size: 15px;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--glass); color: white; padding-right: 20px; }
        .nav-btn.active { border-right: 3px solid var(--primary); background: linear-gradient(90deg, rgba(0,242,255,0.1), transparent); }
        
        /* --- المحتوى الرئيسي --- */
        .content { 
            flex: 1; padding: 25px; overflow-y: auto; position: relative; scroll-behavior: smooth; 
            padding-bottom: 120px; width: 100%;
        }
        .section { display: none; animation: fadeUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .hero-container {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 60vh; text-align: center; padding: 20px;
        }
        .hero-msg {
            font-size: clamp(2rem, 5vw, 4.5rem); font-weight: 900; color: white;
            text-shadow: 0 0 40px rgba(0, 242, 255, 0.3); line-height: 1.3; margin: 0;
        }

        /* --- نظام المجلدات والصوتيات --- */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .folder-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
            transition: 0.3s; aspect-ratio: 1/1; position: relative; overflow: hidden;
        }
        .folder-card::before {
            content:''; position: absolute; inset: 0; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05));
            opacity: 0; transition: 0.3s;
        }
        .folder-card:hover { transform: translateY(-5px); border-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
        .folder-card:hover::before { opacity: 1; }
        .folder-icon { font-size: 40px; color: var(--primary); text-shadow: 0 0 20px rgba(0,242,255,0.4); }
        .folder-name { font-weight: bold; font-size: 16px; text-align: center; }
        .folder-count { font-size: 12px; color: #888; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 10px; }

        /* قائمة الأغاني داخل المجلد */
        .songs-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { background: rgba(255,255,255,0.1); border:none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: black; }

        .song-list-container { display: flex; flex-direction: column; gap: 10px; }
        .song-item { 
            background: rgba(255,255,255,0.03); border-radius: 12px; padding: 10px 15px; 
            cursor: pointer; transition: 0.2s; border: 1px solid transparent; display: flex; align-items: center; gap: 15px;
        }
        .song-item:hover { background: rgba(255,255,255,0.08); }
        .song-item.playing { border-color: var(--primary); background: linear-gradient(90deg, rgba(0, 242, 255, 0.1), transparent); }
        .song-art-sm { width: 50px; height: 50px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
        .song-info { flex: 1; }
        .song-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
        .song-meta { font-size: 11px; color: #888; }
        .equalizer-gif { width: 20px; height: 20px; display: none; }
        .song-item.playing .equalizer-gif { display: block; }

        /* --- اليوميات --- */
        .diary-input-area { background: var(--panel-bg); padding: 20px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--border); }
        .diary-card {
            background: rgba(30, 30, 40, 0.4); padding: 20px; 
            border-radius: 16px; margin-bottom: 20px; position: relative; 
            border: 1px solid var(--border); transition: 0.3s;
        }
        .diary-card:hover { background: rgba(40,40,55, 0.6); transform: translateY(-2px); }
        .diary-card.admin-post { border-right: 4px solid var(--gold); background: linear-gradient(90deg, rgba(255, 215, 0, 0.05), rgba(30,30,40,0.4)); }
        
        .diary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .diary-author { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .diary-avatar { width: 35px; height: 35px; background: #333; border-radius: 50%; display: grid; place-items: center; color: #888; font-size: 14px; }
        .admin-post .diary-avatar { background: var(--gold); color: black; }
        .diary-date { font-size: 11px; color: #777; }
        .diary-text { line-height: 1.7; color: #ddd; font-size: 14px; white-space: pre-wrap; margin-bottom: 15px;}
        
        .diary-actions { display: flex; gap: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
        .action-btn { background: none; border: none; color: #888; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .action-btn:hover { color: white; }
        .action-btn.liked { color: var(--secondary); }
        .action-btn.liked i { animation: pop 0.3s; }
        @keyframes pop { 50% { transform: scale(1.4); } }

        /* --- مشغل الموسيقى المطور --- */
        .music-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-h);
            background: rgba(10, 12, 18, 0.95); border-top: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px; z-index: 100;
            backdrop-filter: blur(15px); gap: 20px;
        }

        .player-left { display: flex; align-items: center; gap: 15px; width: 30%; }
        .p-art { width: 60px; height: 60px; border-radius: 10px; background-size: cover; background-color: #222; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .p-info h4 { margin: 0; font-size: 14px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 150px; }
        .p-info p { margin: 3px 0 0; font-size: 11px; color: #888; }

        .player-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .p-controls { display: flex; align-items: center; gap: 20px; }
        .p-btn { background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .p-btn:hover { color: white; }
        .p-btn.active { color: var(--primary); }
        .play-main { width: 45px; height: 45px; background: white; color: black; border-radius: 50%; display: grid; place-items: center; font-size: 18px; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .play-main:hover { transform: scale(1.1); background: var(--primary); }
        
        .prog-area { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 10px; color: #888; max-width: 500px; }
        .prog-bar-bg { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer; position: relative; }
        .prog-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 2px; position: relative; }
        .prog-fill::after { content:''; position: absolute; right: -5px; top: -3px; width: 10px; height: 10px; background: white; border-radius: 50%; opacity: 0; transition: 0.2s; }
        .prog-bar-bg:hover .prog-fill::after { opacity: 1; }

        .player-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .vol-slider { -webkit-appearance: none; width: 80px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; cursor: pointer; }

        /* --- المدخلات العامة --- */
        .inp-box { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px; border: 1px solid var(--border); display:flex; gap:10px; flex-wrap: wrap;}
        .inp { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 12px 15px; color: white; border-radius: 10px; font-family: inherit; font-size: 14px; transition: 0.3s; }
        .inp:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        .btn { background: var(--primary); color: #000; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; display:inline-flex; align-items:center; justify-content:center; gap:8px;}
        .btn:hover { box-shadow: 0 0 15px rgba(0,242,255,0.4); transform: translateY(-2px); }

        /* --- الموبايل --- */
        .mob-nav { display: none; } 
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .content { padding: 15px; padding-bottom: 150px; }
            .mob-nav { 
                display: flex; gap: 10px; overflow-x: auto; padding: 15px 10px;
                position: sticky; top: 0; z-index: 50; background: rgba(5,5,8,0.9); backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border);
            }
            .mob-nav div { white-space: nowrap; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; color: #ccc; background: rgba(255,255,255,0.08); }
            .mob-nav div.active { background: var(--primary); color: black; font-weight: bold; }
            
            .music-bar { 
                padding: 10px 15px; height: auto; flex-direction: column; 
                background: rgba(15, 15, 20, 0.98); border-top-left-radius: 20px; border-top-right-radius: 20px;
            }
            .player-left { width: 100%; justify-content: flex-start; }
            .player-right { display: none; } /* اخفاء الصوت في الموبايل */
            .player-center { width: 100%; margin-top: 10px; }
            .prog-area { max-width: 100%; }
        }

        /* Admin Styles */
        .admin-overlay { position: fixed; inset: 0; z-index: 500; background: #08080c; display: none; }
        .admin-layout { display: flex; height: 100%; }
        .admin-sidebar { width: 220px; background: #111; border-left: 1px solid #333; padding: 20px; display: flex; flex-direction: column; }
        .admin-main { flex: 1; padding: 30px; overflow-y: auto; }
        .adm-link { padding: 10px; display: block; color: #888; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .adm-link.active, .adm-link:hover { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div class="overlay"></div>

    <div class="layout">
        <nav class="sidebar">
            <div class="brand">AHMED <span>PRO</span></div>
            <div class="nav-btn active" onclick="go('home')"><i class="fas fa-home"></i> الرئيسية</div>
            <div class="nav-btn" onclick="go('audio')"><i class="fas fa-music"></i> الموسيقى</div>
            <div class="nav-btn" onclick="go('diaries')"><i class="fas fa-book-open"></i> اليوميات</div>
            <div class="nav-btn" onclick="go('contact')"><i class="fas fa-paper-plane"></i> راسلني</div>
            
            <div style="margin-top:auto; font-size:12px; color:#555; text-align:center;">
                <span id="visit-counter" style="color:var(--primary)">0</span> الزوار
                <br>
                <span onclick="openAdmin()" style="cursor:pointer; opacity:0.5;">Admin Access</span>
            </div>
        </nav>

        <main class="content">
            <div class="mob-nav">
                <div class="active" onclick="go('home')">الرئيسية</div>
                <div onclick="go('audio')">الموسيقى</div>
                <div onclick="go('diaries')">اليوميات</div>
                <div onclick="go('contact')">اتصل بي</div>
            </div>

            <div id="view-home" class="section active">
                <div class="hero-container">
                    <h1 id="welcome-text" class="hero-msg">جاري تحميل البيانات...</h1>
                </div>
            </div>

            <div id="view-audio" class="section">
                
                <div id="audio-folders-view">
                    <h2 style="color:var(--primary); margin-bottom: 25px;">مكتبة الصوتيات <i class="fas fa-folder-open"></i></h2>
                    <div id="folders-grid" class="folder-grid">
                        </div>
                </div>

                <div id="audio-songs-view" style="display:none;">
                    <div class="songs-header">
                        <button class="back-btn" onclick="showFolders()"><i class="fas fa-arrow-right"></i></button>
                        <h2 style="margin:0; color:white;" id="current-folder-name">اسم المجلد</h2>
                    </div>
                    <div id="folder-songs-list" class="song-list-container">
                        </div>
                </div>

            </div>

            <div id="view-diaries" class="section">
                <h2 style="color:var(--primary); margin-bottom: 20px;">اليوميات والخواطر ✍️</h2>
                
                <div class="diary-input-area">
                    <input id="diary-name" class="inp" placeholder="الاسم (اختياري)" style="margin-bottom:10px;">
                    <textarea id="diary-text" class="inp" rows="3" placeholder="بم تفكر اليوم؟" style="margin-bottom:10px;"></textarea>
                    <button onclick="postDiary()" class="btn"><i class="fas fa-share"></i> نشر</button>
                </div>

                <div id="diaries-list"></div>
            </div>

            <div id="view-contact" class="section">
                <div style="max-width: 600px; margin: 0 auto; background: var(--panel-bg); padding: 40px; border-radius: 20px; text-align: center;">
                    <h2 style="color:var(--primary)">تواصل معي</h2>
                    <p style="color:#aaa; margin-bottom:20px;">أرسل لي رسالة وسأقرأها قريباً</p>
                    <input id="c-name" class="inp" placeholder="اسمك" style="margin-bottom:10px;">
                    <textarea id="c-msg" class="inp" rows="4" placeholder="اكتب رسالتك..." style="margin-bottom:10px;"></textarea>
                    <button onclick="sendMsg()" class="btn" style="width:100%">إرسال</button>
                </div>
            </div>

        </main>
    </div>

    <div class="music-bar" id="music-player-bar">
        <div class="player-left">
            <div class="p-art" id="p-art"></div>
            <div class="p-info">
                <h4 id="p-title">لا يوجد تشغيل</h4>
                <p id="p-artist">اختر أغنية للبدء</p>
            </div>
        </div>
        
        <div class="player-center">
            <div class="p-controls">
                <button class="p-btn" onclick="toggleShuffle()" id="btn-shuffle" title="خلط"><i class="fas fa-random"></i></button>
                <button class="p-btn" onclick="prevSong()"><i class="fas fa-step-backward"></i></button>
                <button class="p-btn play-main" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="p-btn" onclick="nextSong()"><i class="fas fa-step-forward"></i></button>
                <button class="p-btn" onclick="toggleRepeat()" id="btn-repeat" title="تكرار"><i class="fas fa-redo"></i></button>
            </div>
            <div class="prog-area">
                <span id="t-curr">0:00</span>
                <div class="prog-bar-bg" onclick="seek(event)"><div class="prog-fill" id="prog-fill"></div></div>
                <span id="t-total">0:00</span>
            </div>
        </div>

        <div class="player-right">
            <i class="fas fa-volume-up" style="color:#888;"></i>
            <input type="range" class="vol-slider" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)">
        </div>
    </div>

    <div id="admin-panel" class="admin-overlay">
        <div class="admin-layout">
            <aside class="admin-sidebar">
                <h3 style="color:var(--primary)">Admin Control</h3>
                <div class="adm-link active" onclick="switchAdm('music')">إدارة الموسيقى</div>
                <div class="adm-link" onclick="switchAdm('inbox')">الرسائل</div>
                <div class="adm-link" onclick="switchAdm('settings')">الإعدادات</div>
                <button onclick="document.getElementById('admin-panel').style.display='none'" class="btn" style="margin-top:auto; font-size:12px;">خروج</button>
            </aside>
            <main class="admin-main">
                <div id="adm-music" class="adm-sec">
                    <h2>إضافة صوت جديد</h2>
                    <div class="inp-box" style="flex-direction: column;">
                        <input id="new-song-name" class="inp" placeholder="اسم الأغنية">
                        <input id="new-song-url" class="inp" placeholder="رابط الملف (MP3)">
                        <input id="new-song-folder" class="inp" placeholder="اسم المجلد (مثلاً: قرآن، شعبي...)">
                        <input id="new-song-img" class="inp" placeholder="رابط الصورة (اختياري)">
                        <button onclick="addMusic()" class="btn">نشر</button>
                    </div>
                    <hr style="border-color:#333; margin:20px 0;">
                    <div id="adm-list"></div>
                </div>
                <div id="adm-inbox" class="adm-sec" style="display:none;">
                    <h2>الرسائل الواردة</h2>
                    <div id="adm-msgs-list"></div>
                </div>
                <div id="adm-settings" class="adm-sec" style="display:none;">
                    <h2>الإعدادات العامة</h2>
                    <label>رسالة الترحيب:</label>
                    <textarea id="adm-welcome" class="inp" rows="3"></textarea>
                    
                    <label style="margin-top:20px; display:block; color:var(--gold)">الوضع الثابت (صورة ورسالة ثابتة):</label>
                    <div style="background:rgba(255,215,0,0.1); padding:15px; border-radius:10px;">
                        <input type="checkbox" id="adm-custom-check"> تفعيل الوضع الثابت<br><br>
                        <input id="adm-custom-img" class="inp" placeholder="رابط الصورة الثابتة">
                        <textarea id="adm-custom-text" class="inp" placeholder="النص الثابت"></textarea>
                    </div>

                    <button onclick="saveSettings()" class="btn" style="margin-top:20px;">حفظ الكل</button>
                </div>
            </main>
        </div>
    </div>

    <audio id="audio-el"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUK7SXiX_uBObNqWjM5u-eKUKkCTwCJKc",
            authDomain: "mypersonalapp-2f2cc.firebaseapp.com",
            databaseURL: "https://mypersonalapp-2f2cc-default-rtdb.firebaseio.com",
            projectId: "mypersonalapp-2f2cc",
            storageBucket: "mypersonalapp-2f2cc.firebasestorage.app",
            messagingSenderId: "1093218114240",
            appId: "1:1093218114240:web:e082d82c94c286d2c6eb25"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const ADMIN_EMAIL = "ahmshowpic@gmail.com";

        // --- 2. GLOBAL VARIABLES ---
        let allSongs = [];
        let folders = {}; // { "Folder Name": [songs...] }
        let currentPlaylist = [];
        let currentIndex = 0;
        let isShuffle = false;
        let isRepeat = false; // 0: off, 1: all, 2: one (simplified to boolean for now or toggle)
        let isAdmin = false;
        let isCustomMode = false;
        
        const audio = document.getElementById('audio-el');

        // --- 3. AUTH & INITIALIZATION ---
        auth.onAuthStateChanged(user => {
            isAdmin = (user && user.email === ADMIN_EMAIL);
            loadData();
            if(isAdmin) loadAdminData();
        });

        // Increase Visit Count
        db.ref('settings/visitCount').transaction(c => (c || 0) + 1);

        // --- 4. DATA LOADING ---
        function loadData() {
            // Settings
            db.ref('settings').on('value', snap => {
                const val = snap.val() || {};
                document.getElementById('visit-counter').innerText = val.visitCount || 0;
                
                // Hero Logic
                isCustomMode = val.showCustomHero;
                if(isCustomMode) {
                    document.getElementById('welcome-text').innerText = val.customHeroText || "Welcome";
                    document.getElementById('dynamic-bg').style.backgroundImage = `url('${val.customHeroImage}')`;
                    document.getElementById('dynamic-bg').style.opacity = 1;
                } else {
                    document.getElementById('welcome-text').innerText = val.welcomeMsg || "أهلاً بك في عالمي";
                    // Background handled by music player
                }
            });

            // Music
            db.ref('music').on('value', snap => {
                allSongs = [];
                folders = {};
                snap.forEach(c => {
                    const s = { id: c.key, ...c.val() };
                    // Default folder if empty
                    if(!s.folder) s.folder = "منوعات"; 
                    
                    if(!folders[s.folder]) folders[s.folder] = [];
                    folders[s.folder].push(s);
                    allSongs.push(s);
                });
                renderFolders();
            });

            // Diaries
            db.ref('diaries').limitToLast(30).on('value', snap => {
                const list = document.getElementById('diaries-list');
                list.innerHTML = "";
                const data = [];
                snap.forEach(c => data.push({key: c.key, ...c.val()}));
                data.reverse().forEach(d => {
                    const isAdm = d.isAdminPost ? 'admin-post' : '';
                    const likedClass = hasLiked(d.key) ? 'liked' : ''; // LocalStorage check
                    list.innerHTML += `
                    <div class="diary-card ${isAdm}">
                        <div class="diary-header">
                            <div class="diary-author">
                                <div class="diary-avatar"><i class="fas fa-user"></i></div>
                                <span>${escape(d.name)}</span>
                            </div>
                            <span class="diary-date">${d.date}</span>
                        </div>
                        <div class="diary-text">${escape(d.text)}</div>
                        <div class="diary-actions">
                            <button class="action-btn ${likedClass}" onclick="likeDiary('${d.key}')">
                                <i class="fas fa-heart"></i> <span id="like-cnt-${d.key}">${d.likes || 0}</span>
                            </button>
                            ${isAdmin ? `<button onclick="delDiary('${d.key}')" style="color:red; margin-right:auto;">حذف</button>` : ''}
                        </div>
                    </div>`;
                });
            });
        }

        // --- 5. UI RENDERING (MUSIC) ---
        function renderFolders() {
            const grid = document.getElementById('folders-grid');
            grid.innerHTML = "";
            
            // "All Songs" Virtual Folder
            grid.innerHTML += `
                <div class="folder-card" onclick="openFolder('ALL')">
                    <i class="fas fa-music folder-icon"></i>
                    <div class="folder-name">كل الأغاني</div>
                    <div class="folder-count">${allSongs.length} ملف</div>
                </div>
            `;

            Object.keys(folders).forEach(fName => {
                grid.innerHTML += `
                    <div class="folder-card" onclick="openFolder('${fName}')">
                        <i class="fas fa-folder folder-icon"></i>
                        <div class="folder-name">${escape(fName)}</div>
                        <div class="folder-count">${folders[fName].length} ملف</div>
                    </div>
                `;
            });
        }

        function openFolder(folderName) {
            document.getElementById('audio-folders-view').style.display = 'none';
            document.getElementById('audio-songs-view').style.display = 'block';
            
            if(folderName === 'ALL') {
                document.getElementById('current-folder-name').innerText = "كل الأغاني";
                currentPlaylist = [...allSongs];
            } else {
                document.getElementById('current-folder-name').innerText = folderName;
                currentPlaylist = folders[folderName] || [];
            }
            
            renderPlaylistUI();
        }

        function showFolders() {
            document.getElementById('audio-songs-view').style.display = 'none';
            document.getElementById('audio-folders-view').style.display = 'block';
        }

        function renderPlaylistUI() {
            const list = document.getElementById('folder-songs-list');
            list.innerHTML = "";
            currentPlaylist.forEach((s, idx) => {
                const img = s.image || 'https://via.placeholder.com/50';
                list.innerHTML += `
                    <div class="song-item" onclick="playSong(${idx})">
                        <div class="song-art-sm" style="background-image:url('${img}')"></div>
                        <div class="song-info">
                            <div class="song-title">${escape(s.name)}</div>
                            <div class="song-meta">${s.folder}</div>
                        </div>
                        <div class="equalizer-gif"><i class="fas fa-wave-square" style="color:var(--primary)"></i></div>
                    </div>
                `;
            });
        }

        // --- 6. MUSIC PLAYER LOGIC ---
        function playSong(index) {
            currentIndex = index;
            const s = currentPlaylist[currentIndex];
            if(!s) return;
            
            audio.src = s.url;
            audio.play();
            updatePlayerVisuals(s, true);
            
            if(!isCustomMode) {
                document.getElementById('dynamic-bg').style.backgroundImage = `url('${s.image || ""}')`;
            }
            
            // Update active item in list
            document.querySelectorAll('.song-item').forEach(el => el.classList.remove('playing'));
            const listItems = document.getElementById('folder-songs-list').children;
            if(listItems[index]) listItems[index].classList.add('playing');
        }

        function togglePlay() {
            if(!audio.src) { if(currentPlaylist.length) playSong(0); return; }
            if(audio.paused) {
                audio.play(); updatePlayerVisuals(currentPlaylist[currentIndex], true);
            } else {
                audio.pause(); updatePlayerVisuals(currentPlaylist[currentIndex], false);
            }
        }

        function nextSong() {
            if(isShuffle) {
                let r = Math.floor(Math.random() * currentPlaylist.length);
                playSong(r);
            } else {
                let next = currentIndex + 1;
                if(next >= currentPlaylist.length) next = 0; // Loop
                playSong(next);
            }
        }

        function prevSong() {
            let prev = currentIndex - 1;
            if(prev < 0) prev = currentPlaylist.length - 1;
            playSong(prev);
        }

        function updatePlayerVisuals(s, isPlaying) {
            document.getElementById('p-title').innerText = s.name;
            document.getElementById('p-artist').innerText = s.folder;
            document.getElementById('p-art').style.backgroundImage = `url('${s.image || ""}')`;
            document.getElementById('play-icon').className = isPlaying ? "fas fa-pause" : "fas fa-play";
        }

        // Player Events
        audio.ontimeupdate = () => {
            if(audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('prog-fill').style.width = pct + "%";
                document.getElementById('t-curr').innerText = fmtTime(audio.currentTime);
                document.getElementById('t-total').innerText = fmtTime(audio.duration);
            }
        };
        audio.onended = () => {
            if(isRepeat) { audio.currentTime = 0; audio.play(); }
            else { nextSong(); }
        };

        function seek(e) {
            const w = e.currentTarget.clientWidth;
            const clickX = e.offsetX;
            const dur = audio.duration;
            audio.currentTime = (clickX / w) * dur;
        }

        function fmtTime(s) {
            if(isNaN(s)) return "0:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return m + ":" + (sec < 10 ? "0"+sec : sec);
        }

        function setVolume(val) { audio.volume = val; }
        function toggleShuffle() { 
            isShuffle = !isShuffle; 
            document.getElementById('btn-shuffle').classList.toggle('active', isShuffle);
        }
        function toggleRepeat() {
            isRepeat = !isRepeat;
            document.getElementById('btn-repeat').classList.toggle('active', isRepeat);
        }

        // --- 7. DIARY INTERACTIONS ---
        function postDiary() {
            const txt = document.getElementById('diary-text').value;
            const name = document.getElementById('diary-name').value || "زائر";
            if(!txt.trim()) return;
            
            db.ref('diaries').push({
                text: txt, name: name, likes: 0,
                date: new Date().toLocaleDateString('ar-EG'),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isAdminPost: isAdmin
            });
            document.getElementById('diary-text').value = "";
            alert("تم النشر!");
        }

        function likeDiary(key) {
            const k = `liked_${key}`;
            if(localStorage.getItem(k)) return; // Already liked
            
            db.ref(`diaries/${key}/likes`).transaction(likes => (likes || 0) + 1);
            localStorage.setItem(k, true);
        }
        function hasLiked(key) { return localStorage.getItem(`liked_${key}`); }
        function delDiary(key) { if(confirm('حذف؟')) db.ref(`diaries/${key}`).remove(); }

        // --- 8. CONTACT & NAV ---
        function sendMsg() {
            const n = document.getElementById('c-name').value;
            const m = document.getElementById('c-msg').value;
            if(!m) return;
            db.ref('inbox').push({ name:n, msg:m, date: new Date().toLocaleString() });
            alert("تم الإرسال");
        }

        function go(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            
            document.querySelectorAll('.nav-btn, .mob-nav div').forEach(b => b.classList.remove('active'));
            // Very simple mapping logic
            const idxs = {'home':0, 'audio':1, 'diaries':2, 'contact':3};
            const sideBtns = document.querySelectorAll('.sidebar .nav-btn');
            const mobBtns = document.querySelectorAll('.mob-nav div');
            if(sideBtns[idxs[id]]) sideBtns[idxs[id]].classList.add('active');
            if(mobBtns[idxs[id]]) mobBtns[idxs[id]].classList.add('active');
        }

        // --- 9. ADMIN FUNCTIONS ---
        function openAdmin() {
            if(isAdmin) {
                document.getElementById('admin-panel').style.display='flex';
            } else {
                const p = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(p).catch(e => alert(e.message));
            }
        }
        function switchAdm(tab) {
            document.querySelectorAll('.adm-sec').forEach(e => e.style.display='none');
            document.getElementById('adm-'+tab).style.display='block';
            document.querySelectorAll('.adm-link').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addMusic() {
            const n = document.getElementById('new-song-name').value;
            const u = document.getElementById('new-song-url').value;
            const f = document.getElementById('new-song-folder').value;
            const i = document.getElementById('new-song-img').value;
            
            if(!n || !u) return alert("أكمل البيانات");
            
            db.ref('music').push({
                name: n, url: u, folder: f || "منوعات", image: i
            });
            alert("تمت الإضافة");
        }

        function loadAdminData() {
            // Load Messages
            db.ref('inbox').on('value', snap => {
                const c = document.getElementById('adm-msgs-list');
                c.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    c.innerHTML += `<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:5px;">
                        <b>${escape(m.name)}</b>: ${escape(m.msg)}
                        <button onclick="db.ref('inbox/${child.key}').remove()" style="float:left; color:red; border:none; background:none; cursor:pointer;">X</button>
                    </div>`;
                });
            });
            // Load Music for Deletion
            db.ref('music').on('value', snap => {
                const c = document.getElementById('adm-list');
                c.innerHTML = "";
                snap.forEach(child => {
                    const s = child.val();
                    c.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #333;">
                        <span>${escape(s.name)} <small>(${s.folder})</small></span>
                        <button onclick="db.ref('music/${child.key}').remove()" style="color:red; background:none; border:none;">X</button>
                    </div>`;
                });
            });
            // Load Settings Values
            db.ref('settings').once('value', snap => {
                const v = snap.val() || {};
                document.getElementById('adm-welcome').value = v.welcomeMsg || "";
                document.getElementById('adm-custom-check').checked = v.showCustomHero;
                document.getElementById('adm-custom-img').value = v.customHeroImage || "";
                document.getElementById('adm-custom-text').value = v.customHeroText || "";
            });
        }
        
        function saveSettings() {
            db.ref('settings').update({
                welcomeMsg: document.getElementById('adm-welcome').value,
                showCustomHero: document.getElementById('adm-custom-check').checked,
                customHeroImage: document.getElementById('adm-custom-img').value,
                customHeroText: document.getElementById('adm-custom-text').value
            });
            alert("تم الحفظ");
        }

        function escape(s) { return s ? s.replace(/</g, "&lt;") : ""; }
    </script>
</body>
</html>
