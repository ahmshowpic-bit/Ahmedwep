<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AHMED PULSE | PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --gold: #ffd700;
            --bg-deep: #050508;
            --glass-bg: rgba(20, 20, 30, 0.85);
            --card-bg: rgba(30, 30, 40, 0.95);
            --sidebar-w: 260px;
            --player-h: 100px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0;
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-deep); color: #fff; 
            height: 100vh; overflow: hidden;
            transition: background 0.5s;
        }

        /* --- الخلفية --- */
        #dynamic-bg {
            position: fixed; inset: 0; z-index: -2;
            background-size: cover; background-position: center;
            transition: background-image 0.8s ease-in-out, transform 10s ease, filter 0.5s ease;
            /* الوضع الافتراضي (الرئيسية): ساطع */
            filter: brightness(1); 
            opacity: 1; 
            transform: scale(1);
        }
        #dynamic-bg.zoom { transform: scale(1.1); }
        
        /* كلاس التغميق عند الخروج من الرئيسية */
        body.dark-mode #dynamic-bg {
            filter: brightness(0.4); /* تغميق الخلفية لإبراز المحتوى */
        }
        
        .overlay { 
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 40%);
        }

        .layout { display: flex; height: calc(100% - var(--player-h)); position: relative; }
        
        /* --- القائمة الجانبية --- */
        .sidebar {
            width: var(--sidebar-w); 
            background: var(--glass-bg);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; padding: 30px 20px;
            z-index: 20; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .brand { 
            font-size: 26px; font-weight: 900; margin-bottom: 40px; 
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.5);
        }
        .brand span { color: var(--primary); }
        
        .nav-btn {
            padding: 14px 18px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; color: #ccc; transition: 0.2s;
            display: flex; align-items: center; gap: 15px; font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(0, 242, 255, 0.15); color: white; }
        .nav-btn.active { border-right: 4px solid var(--primary); }
        
        /* --- المحتوى --- */
        .content { 
            flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; 
            padding-bottom: 150px;
        }
        .content::-webkit-scrollbar { width: 5px; }
        .content::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }

        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* نص الترحيب */
        #hero-txt {
            font-size: clamp(2.5rem, 6vw, 4.5rem); margin: 0; font-weight: 900; line-height:1.4;
            text-shadow: 0 4px 10px rgba(0,0,0,1), 0 0 20px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.5);
        }

        /* --- اليوميات --- */
        .diary-input-area { 
            background: var(--card-bg); padding: 20px; border-radius: 15px; 
            margin-bottom: 30px; border: 1px solid #444; 
        }
        .diary-feed { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 800px; margin: 0 auto; }
        
        .diary-post {
            background: var(--card-bg); border-radius: 15px;
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 100%; transition: transform 0.2s;
        }
        .diary-post.admin-post { border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.15); }

        .post-header { padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; display: grid; place-items: center; font-weight: bold; color: #fff; font-size: 18px; }
        .admin-post .avatar { background: var(--gold); color: #000; }
        .post-info h4 { margin: 0; font-size: 16px; color: white; display: flex; align-items: center; gap: 6px; }
        .post-info span { font-size: 12px; color: #999; }
        .verified { color: var(--gold); font-size: 14px; }
        .post-body { padding: 15px; font-size: 15px; line-height: 1.6; color: #eee; white-space: pre-wrap; word-wrap: break-word; }
        .post-stats { padding: 8px 15px; font-size: 12px; color: #aaa; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-actions { padding: 5px; display: flex; }
        .action-btn { 
            background: none; border: none; color: #aaa; cursor: pointer; flex: 1;
            font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; 
            transition: 0.2s; padding: 10px; border-radius: 8px;
        }
        .action-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .comments-section { padding: 15px; background: rgba(0,0,0,0.3); display: none; border-radius: 0 0 15px 15px; }
        .comments-section.open { display: block; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; align-items: flex-start; }
        .comment-bubble { background: #3a3b3c; padding: 8px 14px; border-radius: 18px; color: #ddd; flex: 1; }
        .comment-inp-group { display: flex; gap: 10px; margin-top: 15px; }

        /* --- المشغل الموسيقي المطور --- */
        .music-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-h);
            background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100;
        }
        #visualizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.4; pointer-events: none; }
        .player-content { position: relative; z-index: 1; display: flex; width: 100%; align-items: center; justify-content: space-between; }
        
        .play-btn-main { width: 55px; height: 55px; background: white; color: black; border-radius: 50%; display: grid; place-items: center; font-size: 22px; cursor: pointer; transition: 0.2s; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .play-btn-main:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--primary); background: var(--primary); }
        .ctrl-btn { color: white; background: none; border: none; font-size: 24px; cursor: pointer; margin: 0 15px; transition: 0.2s; }
        .ctrl-btn:hover { color: var(--primary); }

        /* تعديل النص تحت اسم الأغنية ليكون بارزاً */
        #p-desc {
            font-size: 12px; 
            color: var(--gold) !important; /* لون ذهبي بارز */
            background: rgba(0,0,0,0.7); /* خلفية سوداء نصف شفافة */
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        /* --- Admin Panel --- */
        .admin-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; 
            display: none; flex-direction: column; backdrop-filter: blur(5px);
        }
        .admin-header { 
            padding: 20px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-body { display: flex; height: 100%; overflow: hidden; }
        .admin-nav { width: 220px; background: rgba(10,10,10,0.5); padding: 20px; border-left: 1px solid #333; }
        .adm-content { flex: 1; padding: 30px; overflow-y: auto; }

        .inp { 
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #444; color: white; 
            padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .btn-glow { 
            background: var(--primary); color: #000; border: none; padding: 10px 25px; 
            border-radius: 25px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); transition: 0.3s;
        }
        .btn-glow:hover { box-shadow: 0 0 25px rgba(0, 242, 255, 0.5); transform: translateY(-2px); }

        .adm-list-item {
            background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent;
        }
        .adm-list-item.active-default { border-color: var(--gold); background: rgba(255, 215, 0, 0.05); }

        /* Mobile */
        .mob-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mob-nav { display: flex; gap: 10px; overflow-x: auto; padding: 12px; background: rgba(15,15,20,0.95); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #333; }
            .mob-chip { white-space: nowrap; padding: 8px 16px; background: #333; border-radius: 20px; font-size: 13px; color: #ccc; text-shadow: 0 1px 2px #000; }
            .mob-chip.active { background: var(--primary); color: black; font-weight: bold; text-shadow: none; }
            .content { padding: 10px; padding-bottom: 130px; }
            .music-bar { height: 130px; padding: 10px; flex-direction: column; justify-content: center; }
            .player-content { flex-direction: column; gap: 8px; width: 100%; }
            .player-left { width: 100%; justify-content: flex-start; }
            .player-right { display: none; }
            .admin-body { flex-direction: column; }
            .admin-nav { width: 100%; height: auto; display: flex; overflow-x: auto; padding: 10px; }
        }
        
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .folder-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s; backdrop-filter: blur(5px); }
        .folder-card:hover { border-color: var(--primary); background: rgba(255,255,255,0.1); transform: translateY(-5px); }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div class="overlay"></div>

    <div class="layout">
        <nav class="sidebar">
            <div class="brand">AHMED <span>PULSE</span></div>
            <div class="nav-items-container" id="sidebar-items">
                <div class="nav-btn active" onclick="nav('home')"><i class="fas fa-home"></i> الرئيسية</div>
                <div class="nav-btn" onclick="nav('music')"><i class="fas fa-music"></i> الموسيقى</div>
                <div class="nav-btn" onclick="nav('diaries')"><i class="fas fa-users"></i> المجتمع</div>
                <div class="nav-btn" onclick="nav('contact')"><i class="fas fa-envelope"></i> تواصل معي</div>
            </div>
            <div style="margin-top:auto; text-align:center;">
                <button onclick="openAdmin()" style="background:none; border:none; color:#ddd; cursor:pointer; font-size:14px; text-shadow:0 1px 2px #000;"><i class="fas fa-cog"></i> لوحة التحكم</button>
            </div>
        </nav>

        <main class="content">
            <div class="mob-nav" id="mob-nav-items">
                <div class="mob-chip active" onclick="nav('home')">الرئيسية</div>
                <div class="mob-chip" onclick="nav('music')">الموسيقى</div>
                <div class="mob-chip" onclick="nav('diaries')">المجتمع</div>
                <div class="mob-chip" onclick="nav('contact')">اتصل</div>
            </div>

            <div id="view-home" class="section active">
                <div style="height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <h1 id="hero-txt">...</h1>
                </div>
            </div>

            <div id="view-music" class="section">
                <h2 style="text-shadow: 0 2px 5px #000;">المكتبة الصوتية</h2>
                <div id="folders-view">
                    <div class="folders-grid" id="folders-container"></div>
                </div>
                <div id="songs-view" style="display:none;">
                    <button onclick="showFolders()" style="background:none; border:none; color:var(--primary); font-size:16px; margin-bottom:15px; cursor:pointer; font-weight:bold; text-shadow: 0 1px 2px #000;">
                        <i class="fas fa-arrow-right"></i> رجوع للمجلدات
                    </button>
                    <h3 id="current-folder-title" style="color:#ddd; text-shadow: 0 1px 2px #000;"></h3>
                    <div id="songs-container" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
            </div>

            <div id="view-diaries" class="section">
                <h2 style="text-shadow: 0 2px 5px #000;">مجتمع اليوميات</h2>
                <div class="diary-input-area">
                    <input id="d-name" class="inp" placeholder="اسمك (اختياري)" maxlength="20">
                    <textarea id="d-msg" class="inp" rows="3" placeholder="بم تفكر اليوم؟"></textarea>
                    <button onclick="postDiary()" class="btn-glow" style="width:100%;">نشر <i class="fas fa-paper-plane"></i></button>
                </div>
                <div id="diary-feed" class="diary-feed">
                    <div id="loading-spinner" style="text-align:center; color:#ccc; padding:20px;">
                        <i class="fas fa-circle-notch fa-spin"></i> جاري تحميل المنشورات...
                    </div>
                </div>
            </div>

            <div id="view-contact" class="section">
                <div style="max-width:500px; margin:auto; background:var(--card-bg); padding:30px; border-radius:15px; border:1px solid #444;">
                    <h2 style="text-align:center; border:none;">راسلني</h2>
                    <input id="c-name" class="inp" placeholder="الاسم">
                    <textarea id="c-msg" class="inp" rows="4" placeholder="رسالتك..."></textarea>
                    <button onclick="sendMsg()" class="btn-glow" style="width:100%">إرسال</button>
                </div>
            </div>

            <div id="dynamic-pages-container"></div>
        </main>
    </div>

    <div class="music-bar">
        <canvas id="visualizer"></canvas>
        <div class="player-content">
            <div class="player-left" style="display:flex; align-items:center; gap:15px; width:280px;">
                <div id="p-art" style="width:60px; height:60px; border-radius:12px; background:#333; background-size:cover; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>
                <div style="overflow:hidden;">
                    <div id="p-title" style="font-weight:bold; font-size:15px; white-space:nowrap; text-shadow:0 1px 2px black;">اختر أغنية</div>
                    <div id="p-desc">...</div>
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                    <button class="ctrl-btn" onclick="prev()"><i class="fas fa-step-backward"></i></button>
                    <div class="play-btn-main" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></div>
                    <button class="ctrl-btn" onclick="next()"><i class="fas fa-step-forward"></i></button>
                </div>
                <div style="width:100%; max-width:450px; height:5px; background:rgba(255,255,255,0.1); border-radius:5px; cursor:pointer; overflow:hidden;" onclick="seek(event)">
                    <div id="prog-fill" style="width:0%; height:100%; background:var(--primary); position:relative; box-shadow:0 0 10px var(--primary);"></div>
                </div>
            </div>

            <div class="player-right" style="width:200px; text-align:left;">
                <i class="fas fa-volume-up" style="color:#aaa; margin-left:5px;"></i>
                <input type="range" style="width:80px; accent-color:var(--primary);" min="0" max="1" step="0.1" oninput="audio.volume=this.value">
            </div>
        </div>
    </div>

    <div id="admin-panel" class="admin-modal">
        <div class="admin-header">
            <b style="color:var(--primary); font-size:20px;">لوحة التحكم <i class="fas fa-user-shield"></i></b>
            <button onclick="document.getElementById('admin-panel').style.display='none'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">✕</button>
        </div>
        <div class="admin-body">
            <div class="admin-nav">
                <div class="nav-btn active" onclick="admTab('inbox')">الرسائل</div>
                <div class="nav-btn" onclick="admTab('music')">الموسيقى</div>
                <div class="nav-btn" onclick="admTab('pages')">الصفحات</div>
                <div class="nav-btn" onclick="admTab('settings')">الإعدادات</div>
            </div>
            <div class="adm-content">
                <div id="adm-inbox" class="section active">
                    <h3>البريد الوارد</h3>
                    <div id="inbox-list"></div>
                </div>
                <div id="adm-music" class="section">
                    <h3>إدارة الموسيقى</h3>
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px;">
                        <input id="add-folder" class="inp" placeholder="اسم المجلد (مثال: شعبي، رومانسي)">
                        <input id="add-title" class="inp" placeholder="اسم الأغنية">
                        <input id="add-url" class="inp" placeholder="رابط الصوت (MP3 URL)">
                        <input id="add-img" class="inp" placeholder="رابط الصورة (Image URL)">
                        <button onclick="addSong()" class="btn-glow" style="font-size:13px;">إضافة للمكتبة</button>
                    </div>
                    <h4 style="color:#888;">الأغاني الحالية (اضغط ★ لجعلها الافتتاحية)</h4>
                    <div id="adm-music-list"></div>
                </div>
                <div id="adm-pages" class="section">
                    <h3>منشئ الصفحات</h3>
                    <input id="page-id" class="inp" placeholder="Page ID (ex: my-story)">
                    <input id="page-title" class="inp" placeholder="العنوان في القائمة">
                    <input id="page-icon" class="inp" placeholder="أيقونة (fas fa-star)">
                    <textarea id="page-content" class="inp" rows="5" placeholder="HTML Content"></textarea>
                    <button onclick="savePage()" class="btn-glow">نشر الصفحة</button>
                    <div id="adm-pages-list" style="margin-top:20px;"></div>
                </div>
                <div id="adm-settings" class="section">
                    <h3>الإعدادات العامة</h3>
                    <label style="color:#aaa; font-size:13px;">رسالة الترحيب:</label>
                    <textarea id="set-welcome" class="inp" rows="3"></textarea>
                    
                    <div style="margin-top:20px; padding:20px; background:rgba(255, 215, 0, 0.08); border-radius:12px; border:1px solid rgba(255,215,0,0.2);">
                        <label style="color:var(--gold); font-weight:bold; font-size:15px;">✨ الوضع الثابت (خلفية ثابتة)</label>
                        <div style="margin:10px 0; display:flex; gap:10px; align-items:center;">
                            <input type="checkbox" id="set-hero-active" style="width:20px; height:20px;"> 
                            <span style="font-size:13px;">تفعيل الخلفية الثابتة (تجاهل صور الأغاني)</span>
                        </div>
                        <input id="set-hero-img" class="inp" placeholder="رابط الصورة الثابتة">
                    </div>
                    
                    <button onclick="saveSettings()" class="btn-glow" style="margin-top:20px; width:100%;">حفظ الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUK7SXiX_uBObNqWjM5u-eKUKkCTwCJKc",
            authDomain: "mypersonalapp-2f2cc.firebaseapp.com",
            databaseURL: "https://mypersonalapp-2f2cc-default-rtdb.firebaseio.com",
            projectId: "mypersonalapp-2f2cc",
            storageBucket: "mypersonalapp-2f2cc.firebasestorage.app",
            messagingSenderId: "1093218114240",
            appId: "1:1093218114240:web:e082d82c94c286d2c6eb25",
            measurementId: "G-W8R99YNJQ9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const ADMIN_EMAIL = "ahmshowpic@gmail.com";

        // Global Vars
        let songs = [], folders = {}, playlist = [], pIndex = 0;
        let isAdmin = false;
        let isCustomMode = false;
        let defaultSongId = null;
        const audio = document.getElementById('audio-player');
        
        audio.removeAttribute('crossorigin');
        
        const fallbackImages = [
            "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1920",
            "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1920"
        ];

        // --- Visualizer Simulation ---
        let canvas, canvasCtx, visInterval;
        function initVisualizer() {
            canvas = document.getElementById('visualizer');
            if(!canvas) return;
            canvasCtx = canvas.getContext('2d');
            startFakeVis();
        }
        function startFakeVis() {
            if(visInterval) cancelAnimationFrame(visInterval);
            const draw = () => {
                if(!audio.paused) {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                    canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                    const bars = 60; const w = canvas.width / bars;
                    for(let i=0; i<bars; i++) {
                        const h = Math.random() * (canvas.height * 0.6);
                        canvasCtx.fillStyle = `rgba(0, 242, 255, 0.3)`;
                        canvasCtx.fillRect(i * w, canvas.height - h, w - 2, h);
                    }
                }
                visInterval = requestAnimationFrame(draw);
            };
            draw();
        }

        // --- Auth & Init ---
        auth.onAuthStateChanged(u => {
            isAdmin = (u && u.email === ADMIN_EMAIL);
            if(isAdmin) initAdmin();
            loadGeneralData();
            initDiarySystem();
            initVisualizer();
        });

        function loadGeneralData() {
            // --- Music Loading ---
            db.ref('music').on('value', snap => {
                songs = []; folders = {};
                snap.forEach(c => {
                    const val = c.val();
                    const s = {
                        k: c.key, 
                        name: val.name,
                        folder: val.folder || "منوعات",
                        image: val.image || val.img,
                        url: val.url || val.link || val.audio 
                    };
                    songs.push(s);
                    if(!folders[s.folder]) folders[s.folder] = [];
                    folders[s.folder].push(s);
                });
                renderFolders();
                checkDefaultSong(); // Check if we need to auto-load
                if(isAdmin) renderAdmMusic();
            });

            // --- Settings Logic ---
            db.ref('settings').on('value', s => {
                const val = s.val() || {};
                
                // 1. Text: Support old and new keys
                document.getElementById('hero-txt').innerText = val.welcome || val.welcomeMsg || "Welcome to AHMED PULSE";
                
                // 2. Default Song ID
                defaultSongId = val.defaultSongId;

                // 3. Hero Mode Logic
                isCustomMode = (val.heroMode === true); 
                
                if(isCustomMode) {
                    setBg(val.heroImg || fallbackImages[0]);
                } else {
                    // If disabled, try to show current song art, else fallback
                    if(audio.src && !audio.paused && playlist[pIndex]) {
                        setBg(playlist[pIndex].image);
                    } else {
                         // Only show fallback if no song is playing
                         if(!audio.src) setBg(fallbackImages[0]);
                    }
                }

                // 4. Sync Admin UI
                if(isAdmin) {
                    if(document.getElementById('set-welcome')) document.getElementById('set-welcome').value = val.welcome || val.welcomeMsg || "";
                    if(document.getElementById('set-hero-active')) document.getElementById('set-hero-active').checked = isCustomMode;
                    if(document.getElementById('set-hero-img')) document.getElementById('set-hero-img').value = val.heroImg || "";
                    renderAdmMusic();
                }
            });

            // Dynamic Pages
            db.ref('custom_pages').on('value', s => {
                document.querySelectorAll('.dyn').forEach(e=>e.remove());
                const admL = document.getElementById('adm-pages-list');
                if(admL) admL.innerHTML = "";
                s.forEach(c => {
                    const p = c.val();
                    const pid = c.key;
                    // Sidebar
                    const btn = document.createElement('div');
                    btn.className = "nav-btn dyn";
                    btn.innerHTML = `<i class="${p.icon}"></i> ${p.title}`;
                    btn.onclick = () => nav(pid);
                    document.getElementById('sidebar-items').appendChild(btn);
                    // Mobile
                    const mb = document.createElement('div');
                    mb.className = "mob-chip dyn";
                    mb.innerText = p.title;
                    mb.onclick = () => nav(pid);
                    document.getElementById('mob-nav-items').appendChild(mb);
                    // Section
                    const sec = document.createElement('div');
                    sec.className = "section dyn-sec";
                    sec.id = "view-"+pid;
                    sec.innerHTML = `<h2>${p.title}</h2><div>${p.content}</div>`;
                    document.getElementById('dynamic-pages-container').appendChild(sec);
                    // Admin List
                    if(admL) admL.innerHTML += `<div>${p.title} <button onclick="db.ref('custom_pages/${pid}').remove()" style="color:red">X</button></div>`;
                });
            });
        }

        // --- Default Song Logic ---
        function checkDefaultSong() {
            if(!audio.src && defaultSongId && songs.length > 0) {
                const song = songs.find(s => s.k === defaultSongId);
                if(song) {
                    document.getElementById('p-title').innerText = song.name;
                    document.getElementById('p-desc').innerText = song.folder;
                    document.getElementById('p-art').style.backgroundImage = `url('${song.image}')`;
                    audio.src = song.url;
                    if(!isCustomMode) setBg(song.image);
                    playlist = folders[song.folder] || songs;
                    pIndex = playlist.findIndex(s => s.k === song.k);
                }
            }
        }

        // --- Diary Logic ---
        function initDiarySystem() {
            const feed = document.getElementById('diary-feed');
            const ref = db.ref('diaries').limitToLast(50);
            
            ref.on('child_added', snapshot => {
                const spinner = document.getElementById('loading-spinner');
                if(spinner) spinner.remove();
                const postData = {k: snapshot.key, ...snapshot.val()};
                const postEl = createPostElement(postData);
                feed.prepend(postEl); 
            });

            ref.on('child_changed', snapshot => {
                const key = snapshot.key;
                const oldEl = document.getElementById('post-' + key);
                if(oldEl) {
                    const newData = {k: key, ...snapshot.val()};
                    const newEl = createPostElement(newData);
                    if(oldEl.querySelector('.comments-section.open')) {
                        newEl.querySelector('.comments-section').classList.add('open');
                    }
                    feed.replaceChild(newEl, oldEl);
                }
            });

            ref.on('child_removed', snapshot => {
                const el = document.getElementById('post-' + snapshot.key);
                if(el) { el.style.transform = 'scale(0)'; setTimeout(() => el.remove(), 200); }
            });
        }

        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = `diary-post ${post.verified ? 'admin-post' : ''}`;
            div.id = 'post-' + post.k;
            const badge = post.verified ? '<i class="fas fa-check-circle verified"></i>' : '';
            const commentsCount = post.comments ? Object.keys(post.comments).length : 0;
            const likesCount = post.likes || 0;

            let commentsHTML = '';
            if(post.comments) {
                Object.values(post.comments).forEach(c => {
                    commentsHTML += `
                        <div class="comment-item">
                            <div style="width:25px; height:25px; background:#555; border-radius:50%; flex-shrink:0;"></div>
                            <div class="comment-bubble">
                                <div style="font-weight:bold; font-size:11px; color:#aaa;">${escapeHtml(c.name)}</div>
                                <div>${escapeHtml(c.text)}</div>
                            </div>
                        </div>`;
                });
            }

            const delBtn = isAdmin ? `<button onclick="db.ref('diaries/${post.k}').remove()" style="margin-right:auto; color:#ff4444; background:none; border:none; cursor:pointer;">✕</button>` : '';
            const contentText = post.text || post.msg || "";

            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar">${post.name.charAt(0)}</div>
                    <div class="post-info">
                        <h4>${escapeHtml(post.name)} ${badge}</h4>
                        <span>${post.date}</span>
                    </div>
                    ${delBtn}
                </div>
                <div class="post-body">${escapeHtml(contentText)}</div>
                <div class="post-stats">
                    <span><i class="fas fa-thumbs-up" style="color:var(--primary)"></i> ${likesCount}</span>
                    <span>${commentsCount} تعليق</span>
                </div>
                <div class="post-actions">
                    <button class="action-btn" onclick="likePost('${post.k}')"><i class="far fa-thumbs-up"></i> أعجبني</button>
                    <button class="action-btn" onclick="toggleComments('${post.k}')"><i class="far fa-comment"></i> تعليق</button>
                </div>
                <div id="comments-${post.k}" class="comments-section">
                    <div id="list-${post.k}">${commentsHTML}</div>
                    <div class="comment-inp-group">
                        <input id="inp-c-${post.k}" class="inp" placeholder="اكتب تعليقاً..." style="margin:0; padding:8px; font-size:12px;">
                        <button onclick="postComment('${post.k}')" class="btn-glow" style="padding:8px 15px; font-size:12px;">نشر</button>
                    </div>
                </div>`;
            return div;
        }

        function likePost(key) { db.ref(`diaries/${key}/likes`).transaction(likes => (likes || 0) + 1); }
        function toggleComments(key) { document.querySelector(`#post-${key} .comments-section`).classList.toggle('open'); }
        function postComment(key) {
            const inp = document.getElementById(`inp-c-${key}`);
            if(!inp.value) return;
            db.ref(`diaries/${key}/comments`).push({ name: isAdmin ? "Admin" : "زائر", text: inp.value, time: Date.now() });
            inp.value = "";
        }
        function postDiary() {
            const n = document.getElementById('d-name').value || "مجهول";
            const m = document.getElementById('d-msg').value;
            if(!m) return alert("اكتب شيئاً!");
            const ver = (isAdmin && confirm("نشر كمسؤول؟"));
            db.ref('diaries').push({
                name: ver ? "AHMED PULSE" : n,
                text: m, msg: m, verified: ver, 
                date: new Date().toLocaleDateString('ar-EG'), likes: 0
            });
            document.getElementById('d-msg').value = "";
            alert("تم النشر!");
        }

        // --- Navigation & UI ---
        function nav(id) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn, .mob-chip').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll(`[onclick="nav('${id}')"]`).forEach(b=>b.classList.add('active'));
            
            // Toggle Dark Mode for BG only when NOT in Home
            if(id === 'home') document.body.classList.remove('dark-mode');
            else document.body.classList.add('dark-mode');
        }

        function setBg(url) {
            const bg = document.getElementById('dynamic-bg');
            if(url) {
                bg.style.backgroundImage = `url('${url}')`;
                bg.classList.add('zoom');
                setTimeout(()=> bg.classList.remove('zoom'), 10000);
            }
        }

        // --- Music Player Logic ---
        function renderFolders() {
            const c = document.getElementById('folders-container');
            c.innerHTML = "";
            Object.keys(folders).forEach(f => {
                c.innerHTML += `<div class="folder-card" onclick="openFolder('${f}')">
                    <i class="fas fa-folder" style="font-size:40px; color:var(--gold); margin-bottom:10px;"></i>
                    <div>${f}</div>
                    <div style="font-size:12px; color:#888;">${folders[f].length} ملفات</div>
                </div>`;
            });
        }
        function openFolder(f) {
            document.getElementById('folders-view').style.display='none';
            document.getElementById('songs-view').style.display='block';
            document.getElementById('current-folder-title').innerText = f;
            const c = document.getElementById('songs-container');
            c.innerHTML = "";
            playlist = folders[f];
            playlist.forEach((s, i) => {
                c.innerHTML += `<div onclick="playSong(${i})" style="display:flex; gap:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; cursor:pointer; align-items:center;">
                    <div style="width:40px; height:40px; background-image:url('${s.image||''}'); background-size:cover; border-radius:5px; background-color:#333;"></div>
                    <div style="font-weight:bold;">${s.name}</div>
                </div>`;
            });
        }
        function showFolders() {
            document.getElementById('songs-view').style.display='none';
            document.getElementById('folders-view').style.display='grid';
        }
        function playSong(i) {
            pIndex = i;
            const s = playlist[pIndex];
            if(!s.url) { alert("رابط الصوت غير صالح"); return; }
            
            audio.src = s.url;
            audio.play().catch(e => console.log("Play Error:", e));
            
            document.getElementById('p-title').innerText = s.name;
            document.getElementById('p-desc').innerText = s.folder;
            document.getElementById('p-art').style.backgroundImage = `url('${s.image}')`;
            document.getElementById('play-icon').className = "fas fa-pause";
            
            if(!isCustomMode && s.image) {
                setBg(s.image);
            }
        }
        function togglePlay() {
            if(audio.paused) { 
                if(audio.src) { audio.play(); document.getElementById('play-icon').className="fas fa-pause"; }
            } else { 
                audio.pause(); document.getElementById('play-icon').className="fas fa-play"; 
            }
        }
        function next() { if(playlist.length) playSong((pIndex+1)%playlist.length); }
        function prev() { if(playlist.length) playSong((pIndex-1+playlist.length)%playlist.length); }
        
        audio.ontimeupdate = () => {
            if(!audio.duration) return;
            document.getElementById('prog-fill').style.width = ((audio.currentTime/audio.duration)*100)+"%";
        };
        function seek(e) {
            if(!audio.duration) return;
            audio.currentTime = (e.offsetX / e.target.offsetWidth) * audio.duration;
        }

        // --- Admin Functions ---
        function openAdmin() {
            if(isAdmin) document.getElementById('admin-panel').style.display='flex';
            else auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(r=>{
                if(r.user.email!==ADMIN_EMAIL) { auth.signOut(); alert("للمسؤول فقط."); } 
                else { document.getElementById('admin-panel').style.display='flex'; }
            }).catch(e => alert(e.message));
        }
        function initAdmin() {
            db.ref('inbox').on('value', s=>{
                const l=document.getElementById('inbox-list'); l.innerHTML="";
                s.forEach(c=>{ l.innerHTML+=`<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:5px;">${escapeHtml(c.val().msg)} <button style="color:red; float:left;" onclick="db.ref('inbox/${c.key}').remove()">✕</button></div>` });
            });
        }
        function admTab(t) {
            document.querySelectorAll('.adm-content .section').forEach(e=>e.classList.remove('active'));
            document.getElementById('adm-'+t).classList.add('active');
        }
        
        // Music Management & Star Logic
        function addSong() {
            db.ref('music').push({
                folder: document.getElementById('add-folder').value,
                name: document.getElementById('add-title').value,
                url: document.getElementById('add-url').value,
                image: document.getElementById('add-img').value
            });
            alert("تم الحفظ");
        }
        function renderAdmMusic() {
            const l = document.getElementById('adm-music-list'); 
            if(!l) return;
            l.innerHTML="";
            songs.forEach(s => { 
                const isDef = (s.k === defaultSongId);
                l.innerHTML += `
                <div class="adm-list-item ${isDef ? 'active-default' : ''}">
                    <span>${s.name} (${s.folder})</span> 
                    <div>
                        <button onclick="setDefaultSong('${s.k}')" style="color:${isDef?'var(--gold)':'#555'}; background:none; border:none; cursor:pointer; font-size:18px;">★</button>
                        <button style="color:red; background:none; border:none; cursor:pointer; margin-right:10px;" onclick="db.ref('music/${s.k}').remove()">✕</button>
                    </div>
                </div>`; 
            });
        }
        window.setDefaultSong = function(id) {
            db.ref('settings').update({ defaultSongId: id });
        };

        // Correct Settings Save (Boolean Fix)
        function saveSettings() {
            db.ref('settings').update({
                welcome: document.getElementById('set-welcome').value,
                heroMode: document.getElementById('set-hero-active').checked,
                heroImg: document.getElementById('set-hero-img').value
            });
            alert("تم حفظ الإعدادات!");
        }

        function savePage() {
            const id = document.getElementById('page-id').value;
            if(id) db.ref('custom_pages/'+id).set({
                title: document.getElementById('page-title').value,
                icon: document.getElementById('page-icon').value,
                content: document.getElementById('page-content').value
            });
            alert("تم النشر");
        }
        function sendMsg() {
            const n = document.getElementById('c-name').value;
            const m = document.getElementById('c-msg').value;
            if(m) { db.ref('inbox').push({name:n, msg:m}); alert("تم الإرسال!"); document.getElementById('c-msg').value = ""; }
        }
        function escapeHtml(text) { return text ? String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])) : ''; }

    </script>
</body>
</html>
